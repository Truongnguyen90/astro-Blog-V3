---
/**
 * Content Table Component
 *
 * Displays content items in a filterable table with search functionality.
 * Uses vanilla JavaScript for lightweight client-side filtering.
 */

import Text from '@/components/fundations/elements/Text.astro';

interface Props {
  items: any[];
  columns: { key: string; label: string; render?: (value: any, item: any) => string }[];
  searchPlaceholder?: string;
  emptyMessage?: string;
}

const {
  items,
  columns,
  searchPlaceholder = 'Search...',
  emptyMessage = 'No items found'
} = Astro.props;

// Generate unique ID for this table instance
const tableId = `table-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="content-table-wrapper">
  <!-- Search Input -->
  <div class="mb-4">
    <input
      type="search"
      placeholder={searchPlaceholder}
      class="w-full md:w-96 px-4 py-2 border border-neutral-300 dark:border-neutral-700 rounded-md bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      data-table-search={tableId}
    />
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full" data-table-id={tableId}>
      <thead class="bg-neutral-50 dark:bg-neutral-800">
        <tr>
          {columns.map(col => (
            <th class="px-6 py-3 text-left text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
              {col.label}
            </th>
          ))}
          <th class="px-6 py-3 text-right text-xs font-medium text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-neutral-900 divide-y divide-neutral-200 dark:divide-neutral-800">
        {items.length === 0 ? (
          <tr>
            <td colspan={columns.length + 1} class="px-6 py-8 text-center">
              <Text tag="p" variant="body" class="text-neutral-500 dark:text-neutral-400">
                {emptyMessage}
              </Text>
            </td>
          </tr>
        ) : (
          items.map(item => (
            <tr class="hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors" data-searchable>
              {columns.map(col => (
                <td class="px-6 py-4 whitespace-nowrap">
                  <Text tag="span" variant="body" class="text-neutral-900 dark:text-neutral-100">
                    {col.render ? (
                      <span set:html={col.render(item.data?.[col.key] ?? item[col.key], item)} />
                    ) : (
                      <span>{item.data?.[col.key] ?? item[col.key] ?? '-'}</span>
                    )}
                  </Text>
                </td>
              ))}
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a
                  href={item.slug ? `/blog/posts/${item.slug}` : item.data?.live || '#'}
                  target="_blank"
                  class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 mr-4"
                  title="View"
                >
                  <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                </a>
              </td>
            </tr>
          ))
        )}
      </tbody>
    </table>
  </div>

  <!-- Empty State (hidden by default, shown by JS when no results) -->
  <div class="hidden py-8 text-center" data-empty-state={tableId}>
    <Text tag="p" variant="body" class="text-neutral-500 dark:text-neutral-400">
      No results found. Try a different search term.
    </Text>
  </div>
</div>

<script define:vars={{ tableId }}>
  // Lightweight vanilla JS search implementation
  const searchInput = document.querySelector(`[data-table-search="${tableId}"]`);
  const table = document.querySelector(`[data-table-id="${tableId}"]`);
  const rows = table?.querySelectorAll('[data-searchable]');
  const emptyState = document.querySelector(`[data-empty-state="${tableId}"]`);
  const tbody = table?.querySelector('tbody');

  if (searchInput && rows) {
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      let visibleCount = 0;

      rows.forEach(row => {
        const text = row.textContent?.toLowerCase() || '';
        const matches = text.includes(query);

        row.style.display = matches ? '' : 'none';
        if (matches) visibleCount++;
      });

      // Show/hide empty state
      if (emptyState && tbody) {
        if (visibleCount === 0 && query !== '') {
          tbody.style.display = 'none';
          emptyState.classList.remove('hidden');
        } else {
          tbody.style.display = '';
          emptyState.classList.add('hidden');
        }
      }
    });
  }
</script>

<style>
  /* Smooth transitions */
  [data-searchable] {
    transition: opacity 0.2s ease-in-out;
  }

  [data-searchable][style*="display: none"] {
    opacity: 0;
  }
</style>
